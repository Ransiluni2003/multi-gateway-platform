deploy:
  needs: test
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4

    - name: Install Railway CLI
      run: npm i -g @railway/cli

    - name: Deploy to Railway (Canary)
      id: deploy
      env:
        RAILWAY_API_KEY: ${{ secrets.RAILWAY_API_KEY }}
      run: |
        echo "üöÄ Starting Canary Deploy..."
        railway login --apiKey $RAILWAY_API_KEY
        railway up --service gateway --detach || exit 1

    - name: Run Smoke Test
      id: smoketest
      run: |
        echo "üß™ Running health check..."
        curl -f https://your-service-canary-url/health || exit 1

    - name: Promote Canary to Production
      if: success()
      run: |
        echo "‚úÖ Canary passed smoke tests. Promoting to production..."
        railway promote --service gateway

    - name: Rollback on Failure
      if: failure()
      env:
        RAILWAY_API_KEY: ${{ secrets.RAILWAY_API_KEY }}
      run: |
        echo "‚ùå Deployment failed. Rolling back to previous version..."
        railway rollback --service gateway || echo "‚ö†Ô∏è Rollback failed."
