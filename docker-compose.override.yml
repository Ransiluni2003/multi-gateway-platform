services:
  # Redis service - Cache layer
  redis:
    image: redis:7
    container_name: redis
    ports:
      - "6379:6379"
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis-secure-password-dev}
    command: 
      - "redis-server"
      - "--requirepass"
      - "${REDIS_PASSWORD:-redis-secure-password-dev}"
      - "--maxmemory"
      - "256mb"
      - "--maxmemory-policy"
      - "allkeys-lru"
      - "--appendonly"
      - "no"
      - "--save"
      - ""
      - "--loglevel"
      - "${REDIS_LOG_LEVEL:-notice}"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # MongoDB service - Primary database
  mongo:
    image: mongo:6
    container_name: mongo
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASS:-mongo-secure-password-dev}
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE:-multi_gateway_db}
    volumes:
      - mongo-data:/data/db
      - mongo-config:/data/configdb
    command: 
      - "--auth"
      - "--logpath"
      - "/var/log/mongodb/mongodb.log"
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # API service - Main application
  api:
    build:
      context: ./backend
      dockerfile: ./src/services/api/Dockerfile
    container_name: api
    ports:
      - "${API_PORT:-5002}:3000"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis-secure-password-dev}
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis-secure-password-dev}@redis:6379/0
      MONGO_URL: mongodb://${MONGO_USER:-admin}:${MONGO_PASS:-mongo-secure-password-dev}@mongo:27017/${MONGO_INITDB_DATABASE:-multi_gateway_db}?authSource=admin
      HEALTH_CHECK_INTERVAL: ${HEALTH_CHECK_INTERVAL:-10000}
      DEBUG: ${DEBUG:-true}
      VERBOSE_LOGGING: ${VERBOSE_LOGGING:-true}
    depends_on:
      redis:
        condition: service_healthy
      mongo:
        condition: service_healthy
      payments:
        condition: service_started
    networks:
      - backend-network
    healthcheck:
      test: ["CMD-SHELL", "node -e \"const http=require('http'); http.get('http://localhost:3000/health', r=>process.exit(r.statusCode===200?0:1)).on('error', ()=>process.exit(1));\""]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # Payments service - Payment processing
  payments:
    build:
      context: ./backend
      dockerfile: ./src/services/payments/Dockerfile
    container_name: payments
    ports:
      - "${PAYMENTS_PORT:-5003}:4001"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      PAYMENT_GATEWAY_URL: http://mock-payment-gateway:5000
      PAYMENT_TIMEOUT: ${PAYMENT_TIMEOUT:-10000}
      PAYMENT_RETRY_ATTEMPTS: ${PAYMENT_RETRY_ATTEMPTS:-3}
      PAYMENT_RETRY_DELAY: ${PAYMENT_RETRY_DELAY:-1000}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis-secure-password-dev}
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis-secure-password-dev}@redis:6379/0
      MONGO_USER: ${MONGO_USER:-root}
      MONGO_PASS: ${MONGO_PASS:-rootpassword}
      MONGO_URL: mongodb://${MONGO_USER:-root}:${MONGO_PASS:-rootpassword}@mongo:27017/${MONGO_INITDB_DATABASE:-multi_gateway_db}?authSource=admin
      CIRCUIT_BREAKER_THRESHOLD: ${CIRCUIT_BREAKER_THRESHOLD:-5}
      CIRCUIT_BREAKER_TIMEOUT: ${CIRCUIT_BREAKER_TIMEOUT:-60000}
      RETRY_MAX_ATTEMPTS: ${RETRY_MAX_ATTEMPTS:-3}
      DEBUG: ${DEBUG:-true}
    depends_on:
      redis:
        condition: service_healthy
      mongo:
        condition: service_healthy
      mock-payment-gateway:
        condition: service_started
    networks:
      - backend-network
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:4001/api/payments/health', r => { process.exit(r.statusCode === 200 ? 0 : 1); }).on('error', () => process.exit(1));\""]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # Mock Payment Gateway - External service simulator
  mock-payment-gateway:
    build:
      context: ./mock-payment
      dockerfile: ./Dockerfile
    container_name: mock-payment-gateway
    ports:
      - "${MOCK_GATEWAY_PORT:-5000}:5000"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 5000
      MOCK_PAYMENT_SUCCESS_RATE: ${MOCK_PAYMENT_SUCCESS_RATE:-95}
      MOCK_PAYMENT_TIMEOUT_PERCENTAGE: ${MOCK_PAYMENT_TIMEOUT_PERCENTAGE:-5}
      MOCK_PAYMENT_LATENCY_MS: ${MOCK_PAYMENT_LATENCY_MS:-100}
      DEBUG: ${DEBUG:-true}
    networks:
      - backend-network
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:5000/health', r => { process.exit(r.statusCode === 200 ? 0 : 1); }).on('error', () => process.exit(1));\""]
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Prometheus - Metrics collection
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    environment:
      - PROMETHEUS_SCRAPE_INTERVAL=15s
      - PROMETHEUS_EVALUATION_INTERVAL=15s
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=7d"
    networks:
      - backend-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Volumes for persistent data
volumes:
  mongo-data:
    driver: local
  mongo-config:
    driver: local
  redis-data:
    driver: local
  prometheus-data:
    driver: local

# Networks
networks:
  backend-network:
    driver: bridge
