services:
  # Redis service
  redis:
    image: redis:7
    container_name: redis
    ports:
      - "6379:6379"
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    command: ["redis-server", "--maxmemory", "256mb", "--maxmemory-policy", "allkeys-lru", "--appendonly", "no", "--save", ""]
    networks:
      - backend-network

  # MongoDB service
  mongo:
    image: mongo:6
    container_name: mongo
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASS}
    volumes:
      - mongo-data:/data/db
    networks:
      - backend-network

  # API service
  api:
    build:
      context: ./backend
      dockerfile: ./src/services/api/Dockerfile
    container_name: api
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - REDIS_URL=redis://redis:6379
      - MONGO_URL=mongodb://mongo:27017/devdb
    depends_on:
      - payments
      - redis
      - mongo
    networks:
      - backend-network

  # Payments service
  payments:
    build:
      context: ./backend
      dockerfile: ./src/services/payments/Dockerfile
    container_name: payments
    ports:
      - "3001:3000"
    environment:
      - PAYMENT_GATEWAY_URL=http://mock-payment-gateway:5000
      - REDIS_URL=redis://redis:6379
      - MONGO_URL=mongodb://mongo:27017/devdb
    depends_on:
      - redis
      - mongo
    networks:
      - backend-network

  # Mock Payment Gateway for testing
  mock-payment-gateway:
    build: ./mock-payment
    container_name: mock-payment-gateway
    working_dir: /app
    volumes:
      - ./mock-payment:/app
    command: ["node", "index.js"]
    ports:
      - "5000:5000"
    networks:
      - backend-network

  # RabbitMQ for queues (used by payment worker / retry / dlq)
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    networks:
      - backend-network

  # OpenTelemetry Collector for traces/metrics
  otel-collector:
    image: otel/opentelemetry-collector:0.77.0
    container_name: otel-collector
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    command: ["--config", "/etc/otel-collector-config.yaml"]
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "8888:8888"   # Prometheus metrics from collector
    networks:
      - backend-network

  # Note: worker scaling is handled at runtime with `--scale worker=<n>`.
  # Do not set `container_name` together with `deploy.replicas` in compose files
  # because they conflict when scaling locally. Use the `worker` service
  # defined in the main docker-compose.yml and scale it at runtime:
  #   docker-compose -f docker-compose.yml -f docker-compose.override.yml up --build -d --scale worker=5

# Volumes
volumes:
  mongo-data:

# Networks
networks:
  backend-network:
    driver: bridge
