# Redis High-Performance Configuration
# Optimized for 1000+ concurrent connections and high-throughput job queues

# ============================================================================
# NETWORK
# ============================================================================

# Max connections - increased for high concurrency
maxclients 10000

# TCP backlog - helps with connection bursts
tcp-backlog 511

# Keep connection alive
tcp-keepalive 300

# No timeout for idle connections (BullMQ needs persistent connections)
timeout 0

# ============================================================================
# MEMORY MANAGEMENT
# ============================================================================

# Set max memory to 2GB (adjust based on your system)
maxmemory 2gb

# Eviction policy - use allkeys-lru for general purpose
# allkeys-lru: Remove any key using LRU algorithm
# volatile-lru: Remove keys with expire set using LRU
# noeviction: Return errors when memory limit reached (recommended for queues)
maxmemory-policy noeviction

# ============================================================================
# PERSISTENCE - DISABLED FOR PERFORMANCE
# ============================================================================
# NOTE: For production, enable RDB or AOF on replica nodes only

# Disable RDB snapshots (no disk I/O during high load)
save ""

# Disable AOF (Append-Only File)
appendonly no

# If AOF is needed in production:
# appendonly yes
# appendfsync everysec
# no-appendfsync-on-rewrite yes
# auto-aof-rewrite-percentage 100
# auto-aof-rewrite-min-size 64mb

# ============================================================================
# PERFORMANCE TUNING
# ============================================================================

# Lazy freeing - free memory in background thread
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# Hash optimization for small hashes (BullMQ job data)
hash-max-listpack-entries 512
hash-max-listpack-value 64

# List optimization (for queues)
list-max-listpack-size -2
list-compress-depth 0

# Set optimization
set-max-intset-entries 512

# Sorted set optimization (for delayed/scheduled jobs)
zset-max-listpack-entries 128
zset-max-listpack-value 64

# ============================================================================
# MONITORING & DEBUGGING
# ============================================================================

# Slow log - track commands taking > 10ms
slowlog-log-slower-than 10000
slowlog-max-len 128

# Latency monitoring - track events taking > 100ms
latency-monitor-threshold 100

# Log level
loglevel notice

# ============================================================================
# SECURITY (Uncomment and set for production)
# ============================================================================

# requirepass your-strong-password-here
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command CONFIG ""

# ============================================================================
# CLUSTER CONFIGURATION (For horizontal scaling)
# ============================================================================
# Uncomment these for Redis Cluster mode:

# cluster-enabled yes
# cluster-config-file nodes.conf
# cluster-node-timeout 15000
# cluster-replica-validity-factor 10
# cluster-migration-barrier 1
# cluster-require-full-coverage yes

# ============================================================================
# REPLICATION (For high availability)
# ============================================================================
# On replica nodes only:

# replicaof <master-ip> <master-port>
# replica-read-only yes
# repl-diskless-sync yes
# repl-diskless-sync-delay 5

# ============================================================================
# CLIENT OUTPUT BUFFER LIMITS
# ============================================================================
# Prevent memory issues from slow clients

client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# ============================================================================
# ADVANCED SETTINGS
# ============================================================================

# Active defragmentation (Redis 4.0+)
# Helps reduce memory fragmentation
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 25
active-defrag-cycle-min 5
active-defrag-cycle-max 75

# Hz - internal timer frequency (10-500, default 10)
# Higher = better latency for expirations but more CPU
hz 10

# Database count (default 16, reduce if not using multiple DBs)
databases 16
