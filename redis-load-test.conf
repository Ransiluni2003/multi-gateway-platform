# Redis Configuration - Optimized for High-Load BullMQ Queues
# Supports 1000+ concurrent requests, 5 workers, multiple queues

################################ GENERAL ###############################
# Note: all the following is the configuration of the database

# Accept connections only from specific IP (comment out for all)
bind 0.0.0.0

# Set the port for Redis
port 6379

# TCP listen() backlog. Default is 511.
tcp-backlog 1024

# Close the connection after a client is idle for N seconds
timeout 0

# TCP keepalive. Default is 300.
tcp-keepalive 300

# Daemonize (no for Docker)
daemonize no

# Loglevel
loglevel notice

# Max number of connected clients
maxclients 50000

################################ SNAPSHOTTING  ################################
# For load testing, disable persistence (can re-enable for production)
# This significantly improves throughput
save ""

# AOF (Append Only File) - disabled for performance
appendonly no

################################ MEMORY MANAGEMENT #######################

# Max memory Redis can use
maxmemory 4gb

# Memory eviction policy for high load
# 'allkeys-lru' = evict any key using LRU (recommended for queues)
# 'volatile-lru' = evict only keys with TTL
maxmemory-policy allkeys-lru

################################ LAZY FREEING ################################
# Free memory asynchronously (non-blocking)
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes
lazyfree-lazy-user-del yes

################################ THREADED I/O ###########################
# Use threaded I/O for network operations
# Improves throughput on multi-core systems
io-threads 4
io-threads-do-reads yes

################################ COMMAND RENAMING ############################
# Rename dangerous commands (optional)
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""

################################ SLOW LOG ###################################
# Log queries slower than specified microseconds
slowlog-log-slower-than 10000
slowlog-max-len 128

################################ LATENCY MONITOR ##############################
# Monitor latency (useful for debugging)
latency-monitor-threshold 100

################################ CLIENT OUTPUT BUFFER LIMITS #################
# Prevent memory issues from slow clients
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

################################ HZ ########################################
# Frequency of internal Redis background jobs
# Higher values = faster timeout cleanup but more CPU
hz 10

################################ ACTIVE REHASHING ###########################
# Rehash the hash table to reduce memory fragmentation
active-rehashing yes

################################ CONFIG REWRITE #############################
# Allow CONFIG REWRITE command
# CONFIG REWRITE writes current configuration to disk
