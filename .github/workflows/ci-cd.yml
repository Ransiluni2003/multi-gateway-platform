name: CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create .env file from GitHub Secrets
        run: |
          echo "MONGO_URL=${{ secrets.MONGO_URL }}" >> .env
          echo "RAILWAY_API_KEY=${{ secrets.RAILWAY_API_KEY }}" >> .env
          echo "REDIS_URL=${{ secrets.REDIS_URL }}" >> .env
          echo "SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}" >> .env
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> .env
          echo "VERCEL_ORG_ID=${{ secrets.VERCEL_ORG_ID }}" >> .env
          echo "VERCEL_PROJECT_ID=${{ secrets.VERCEL_PROJECT_ID }}" >> .env
          echo "VERCEL_TOKEN=${{ secrets.VERCEL_TOKEN }}" >> .env
          echo "MONGO_USER=${{ secrets.MONGO_USER }}" >> .env
          echo "MONGO_PASS=${{ secrets.MONGO_PASS }}" >> .env
          echo "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" >> .env

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to DockerHub
        if: ${{ secrets.DOCKER_USERNAME && secrets.DOCKER_PASSWORD }}
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build backend images
        run: |
          docker buildx build --platform linux/amd64 -f backend/Dockerfile -t multi-gateway-backend:latest --load ./backend
          docker buildx build --platform linux/amd64 -f backend/src/services/payments/Dockerfile -t multi-gateway-payments:latest --load ./backend
          docker buildx build --platform linux/amd64 -f backend/src/services/analytics/Dockerfile -t multi-gateway-analytics:latest --load ./backend
          docker buildx build --platform linux/amd64 -f backend/src/services/notifications/Dockerfile -t multi-gateway-notifications:latest --load ./backend

          docker-compose -f docker-compose.override.yml up -d

      - name: Deploy Backend to Railway
        run: |
          npm install -g railway
          railway up --token ${{ secrets.RAILWAY_TOKEN }} || echo "Railway deploy failed" > railway_error.log
        continue-on-error: true

      - name: Rollback Railway on failure
        if: failure()
        run: |
          echo "Rolling back Railway deployment..."
          railway rollback --token ${{ secrets.RAILWAY_TOKEN }}

      - name: Deploy Frontend to Vercel
        run: |
          npm install -g vercel
          vercel --prod --token ${{ secrets.VERCEL_TOKEN }} || echo "Vercel deploy failed" > vercel_error.log
        continue-on-error: true

      - name: Rollback Vercel on failure
        if: failure()
        run: |
          echo "Rolling back Vercel deployment..."
          # Example: promote previous deployment (requires Vercel CLI/API)
          # vercel promote <previous-deployment-id> --token ${{ secrets.VERCEL_TOKEN }}

      - name: Run integration tests
        run: echo "Run your integration tests here"

      - name: Upload error logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-error-logs
          path: |
            railway_error.log
            vercel_error.log

      - name: Notify on failure
        if: failure()
        run: echo "Deployment failed! Send notification here (Slack, email, etc.)"
