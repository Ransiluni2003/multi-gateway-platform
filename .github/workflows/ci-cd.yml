name: CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to DockerHub
        if: secrets.DOCKER_USERNAME && secrets.DOCKER_PASSWORD
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build backend images
        run: |
          docker buildx build --platform linux/amd64 -f backend/Dockerfile -t multi-gateway-backend:latest --load ./backend
          docker buildx build --platform linux/amd64 -f backend/src/services/payments/Dockerfile -t multi-gateway-payments:latest --load ./backend
          docker buildx build --platform linux/amd64 -f backend/src/services/analytics/Dockerfile -t multi-gateway-analytics:latest --load ./backend
          docker buildx build --platform linux/amd64 -f backend/src/services/notifications/Dockerfile -t multi-gateway-notifications:latest --load ./backend


      - name: Install backend dependencies
        run: |
          cd backend
          npm ci

      - name: Run backend tests
        run: |
          cd backend
          npm test

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Run frontend tests
        run: |
          cd frontend
          npm test || echo "No frontend tests configured"

      - name: Deploy backend to Railway
        if: ${{ secrets.RAILWAY_TOKEN }}
        uses: railwayapp/cli-action@v1
        with:
          railwayToken: ${{ secrets.RAILWAY_TOKEN }}
          command: up

      - name: Deploy frontend to Vercel
        if: ${{ secrets.VERCEL_TOKEN }}
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./frontend
          prod: true

  post-deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Notify
        run: echo "CI/CD pipeline completed"
name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker images
        run: |
          docker build -t $REGISTRY/${IMAGE_NAME}/service1:latest ./services/service1
          docker build -t $REGISTRY/${IMAGE_NAME}/service2:latest ./services/service2
          docker push $REGISTRY/${IMAGE_NAME}/service1:latest
          docker push $REGISTRY/${IMAGE_NAME}/service2:latest

      - name: Run integration tests
        run: |
          docker-compose -f docker-compose.override.yml up -d
          docker exec service1_container npm test
          docker exec service2_container npm test
          docker-compose -f docker-compose.override.yml down


      - name: Deploy Backend to Railway
        id: deploy-railway
        run: |
          set -e
          if ! railway up --detach; then
            echo "Railway deploy failed, attempting rollback..."
            railway deployments rollback || echo "Rollback failed! Manual intervention required."
            echo "::error ::Railway deployment failed and rollback attempted."
            exit 1
          fi
        env:
          RAILWAY_API_KEY: ${{ secrets.RAILWAY_API_KEY }}

      - name: Deploy Frontend to Vercel
        id: deploy-vercel
        run: |
          set -e
          cd frontend
          if ! npx vercel --prod --token ${{ secrets.VERCEL_TOKEN }}; then
            echo "Vercel deploy failed, attempting rollback..."
            # Get previous deployment URL and redeploy (Vercel CLI does not support true rollback, so redeploy previous commit)
            PREV_URL=$(npx vercel ls --prod --token ${{ secrets.VERCEL_TOKEN }} | grep production | head -n 2 | tail -n 1 | awk '{print $2}')
            if [ -n "$PREV_URL" ]; then
              npx vercel --prod --token ${{ secrets.VERCEL_TOKEN }} --force --confirm --scope ${{ secrets.VERCEL_ORG_ID }}
            else
              echo "No previous Vercel deployment found. Manual intervention required."
            fi
            echo "::error ::Vercel deployment failed and rollback attempted."
            exit 1
          fi

      - name: Notify on Failure
        if: failure()
        run: |
          echo "Deployment failed. Please check the logs above for details." > summary.txt
          # Optionally send to Slack/email here
        continue-on-error: true
