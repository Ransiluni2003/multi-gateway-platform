name: 'Security: Secrets Validation'

on:
  pull_request:
    paths:
      - '.env*'
      - '**.js'
      - '**.ts'
      - '**.tsx'
  push:
    branches:
      - main
      - develop
      - pinithi

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install TruffleHog
        run: |
          pip install truffleHog

      - name: Scan for exposed secrets
        run: |
          trufflehog filesystem . --json > results.json || true
          cat results.json

      - name: Check for .env files
        run: |
          if find . -name ".env" -o -name ".env.local" | grep -v node_modules; then
            echo "❌ WARNING: .env files found in repository!"
            exit 1
          else
            echo "✅ No .env files committed"
          fi

      - name: Verify .gitignore protects secrets
        run: |
          if grep -q "\.env" .gitignore; then
            echo "✅ .env files are in .gitignore"
          else
            echo "❌ ERROR: .env files not in .gitignore"
            exit 1
          fi

  validate-env-examples:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check .env.example files exist
        run: |
          if [ ! -f "backend/.env.example" ]; then
            echo "❌ Missing backend/.env.example"
            exit 1
          fi
          if [ ! -f "frontend/.env.example" ]; then
            echo "❌ Missing frontend/.env.example"
            exit 1
          fi
          echo "✅ All .env.example files present"

      - name: Verify .env.example has no real secrets
        run: |
          if grep -r "sk_test_\|sk_live_" backend/.env.example frontend/.env.example; then
            echo "❌ Real API keys found in .env.example"
            exit 1
          fi
          if grep -r "@mongodb.net" backend/.env.example | grep -v "your_"; then
            echo "❌ Real MongoDB URI found in .env.example"
            exit 1
          fi
          echo "✅ No real secrets in .env.example files"
